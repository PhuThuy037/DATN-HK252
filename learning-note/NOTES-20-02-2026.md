# ğŸ“… 2026-02-20 â€“ Setup Alembic + SQLModel + Docker + pgvector

## ğŸ¯ Objective

Thiáº¿t láº­p há»‡ thá»‘ng migration cho project vá»›i cÃ¡c cÃ´ng nghá»‡:

- FastAPI
- SQLModel
- PostgreSQL (pgvector)
- Docker + WSL2
- `uv` (package manager)
- Alembic autogenerate

---

## ğŸ§¨ Issues Encountered & Fixes

### 1. Alembic khÃ´ng detect models (migration file rá»—ng)

- **Cause:** File `env.py` chÆ°a import toÃ n bá»™ models dáº«n Ä‘áº¿n `SQLModel.metadata` chÆ°a Ä‘Æ°á»£c populate.
- **Fix:** Import file chá»©a toÃ n bá»™ models vÃ  gÃ¡n `target_metadata`.
  ```python
  import app.db.all_models  # noqa: F401
  target_metadata = SQLModel.metadata
  ```

### 2. Ruff tá»± Ä‘á»™ng xoÃ¡ import model

- **Cause:** Linter/Formatter Ruff nháº­n diá»‡n Ä‘Ã¢y lÃ  import khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng.
- **Fix:** ThÃªm comment `noqa` Ä‘á»ƒ bá» qua lá»—i nÃ y.
  ```python
  import app.db.all_models  # noqa: F401
  ```

### 3. Lá»—i `alembic: executable not found` khi dÃ¹ng `uv`

- **Cause:** Alembic khÃ´ng náº±m trong `PATH` global vÃ¬ project Ä‘ang sá»­ dá»¥ng environment cá»§a `uv`.
- **Fix:** Äá»‹nh nghÄ©a láº¡i trong `Makefile` Ä‘á»ƒ cháº¡y qua `uv`.
  ```bash
  uv run python -m alembic ...
  ```

### 4. `post_write_hooks` trong `pyproject.toml` gÃ¢y crash

- **Cause:** Alembic khÃ´ng há»— trá»£ cáº¥u trÃºc nested TOML cho `post_write_hooks`.
- **Fix:** XoÃ¡ block `[tool.alembic.post_write_hooks]` khá»i file cáº¥u hÃ¬nh.

### 5. SQLModel MRO Error vá»›i `TimestampMixin`

- **Cause:** Lá»—i `Cannot create a consistent method resolution order`. Mixin káº¿ thá»«a trá»±c tiáº¿p tá»« `SQLModel` hoáº·c sai
  thá»© tá»± base class.
- **Fix:** Mixin khÃ´ng Ä‘Æ°á»£c káº¿ thá»«a `SQLModel`. Base model cáº§n Ä‘á»‹nh nghÄ©a Ä‘Ãºng thá»© tá»±.
  ```python
  class User(TimestampMixin, SQLModel, table=True):
      ...
  ```

### 6. Lá»—i `Column 'created_at' already assigned to Table`

- **Cause:** Reuse cÃ¹ng má»™t object `sa.Column()` trong mixin cho nhiá»u table khÃ¡c nhau.
- **Fix:** Sá»­ dá»¥ng `sa_column_kwargs` hoáº·c decorator `@declared_attr`.

### 7. Lá»—i truyá»n `nullable` khi cÃ³ `sa_column`

- **Cause:** Bá»‹ lá»—i `RuntimeError: Passing nullable is not supported when also passing a sa_column`. Cháº³ng háº¡n:
  `Field(sa_column=Column(...), nullable=False)`.
- **Fix:** `nullable` pháº£i Ä‘Æ°á»£c khai bÃ¡o bÃªn trong `Column()`, khÃ´ng náº±m á»Ÿ tham sá»‘ cá»§a `Field()`.

### 8. `PydanticUserError: Optional = typing.Optional`

- **Cause:** Lá»—i do import `Optional` á»Ÿ bÃªn trong class model.
- **Fix:** Move import lÃªn Ä‘áº§u file.

### 9. Lá»—i `Can't load plugin: sqlalchemy.dialects:driver`

- **Cause:** Cáº¥u hÃ¬nh `sqlalchemy.url` sai hoáº·c dÃ¹ng string interpolation `%()` khÃ´ng Ä‘Ãºng chuáº©n.
- **Fix:** Äá»c `DATABASE_URL` trá»±c tiáº¿p tá»« environment variable trong `env.py`.
  ```python
  import os
  db_url = os.getenv("DATABASE_URL")
  ```

### 10. Migration file bá»‹ root-owned (WSL + Docker)

- **Cause:** Lá»‡nh `docker compose exec` máº·c Ä‘á»‹nh cháº¡y vá»›i quyá»n root, nÃªn cÃ¡c file gen ra cÅ©ng thuá»™c quyá»n root.
- **Fix:** Cháº¡y exec vá»›i cá» user trong `Makefile`.
  ```bash
  docker compose exec -u $(UID):$(GID) ...
  ```

### 11. `uv` cache permission denied

- **Cause:** Lá»—i `Failed to initialize cache at /tmp/uv-cache`. Cache Ä‘Ã£ Ä‘Æ°á»£c táº¡o bá»Ÿi quyá»n root trÆ°á»›c Ä‘Ã³.
- **Fix:** Set láº¡i environment variable hoáº·c chown láº¡i thÆ° má»¥c (hoáº·c recreate láº¡i volume).
  ```bash
  -e UV_CACHE_DIR=/tmp/uv-cache
  ```

### 12. `NameError: sqlmodel not defined` trong file migration

- **Cause:** Alembic tá»± Ä‘á»™ng generate type `sqlmodel.sql.sqltypes.AutoString()` nhÆ°ng thiáº¿u dÃ²ng import thÆ° viá»‡n.
- **Fix:** Bá»• sung thá»§ cÃ´ng vÃ o file migration.
  ```python
  import sqlmodel
  ```

### 13. `NameError: pgvector not defined`

- **Cause:** File migration sá»­ dá»¥ng field cá»§a pgvector nhÆ°ng thiáº¿u import.
- **Fix:** ThÃªm dÃ²ng sau vÃ o file migration.
  ```python
  import pgvector
  # hoáº·c
  from pgvector.sqlalchemy import Vector
  ```

### 14. `psycopg.errors.UndefinedObject: type "vector" does not exist`

- **Cause:** Database PostgreSQL hiá»‡n táº¡i chÆ°a Ä‘Æ°á»£c enable extension `pgvector`.
- **Fix:** Bá»• sung lá»‡nh táº¡o extension vÃ o ngay Ä‘áº§u hÃ m `upgrade()` trong file migration Ä‘áº§u tiÃªn.
  ```python
  def upgrade():
      op.execute("CREATE EXTENSION IF NOT EXISTS vector")
      ...
  ```

---

## âœ… Final System State

- [x] Docker networking hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng.
- [x] `DATABASE_URL` load thÃ nh cÃ´ng tá»« environment variables.
- [x] Alembic autogenerate nháº­n diá»‡n model OK.
- [x] SQLModel metadata OK.
- [x] pgvector extension Ä‘Ã£ Ä‘Æ°á»£c enabled.
- [x] Cháº¡y migration thÃ nh cÃ´ng.
- [x] CÃ¡c váº¥n Ä‘á» vá» Permission trÃªn WSL Ä‘Ã£ Ä‘Æ°á»£c fix.
- [x] Váº¥n Ä‘á» cache cá»§a `uv` Ä‘Ã£ Ä‘Æ°á»£c fix.

---

## ğŸ§  Lessons Learned

* **SQLModel + Alembic:** Tá»“n táº¡i khÃ¡ nhiá»u edge-case khi xá»­ lÃ½ khai bÃ¡o `sa_column`.
* **Docker + WSL:** Permission cá»§a file gen ra tá»« container luÃ´n lÃ  váº¥n Ä‘á» phá»• biáº¿n cáº§n lÆ°u Ã½ (map `UID/GID`).
* **pgvector:** Báº¯t buá»™c pháº£i cháº¡y `CREATE EXTENSION` á»Ÿ database level.
* **uv:** Cache directory cáº§n Ä‘Æ°á»£c setup Ä‘Ãºng quyá»n khi sá»­ dá»¥ng user non-root.
* **Alembic config:** KhÃ´ng tá»± Ä‘á»™ng Ä‘á»c environment variables náº¿u khÃ´ng tá»± code override láº¡i cáº¥u hÃ¬nh trong file
  `env.py`.